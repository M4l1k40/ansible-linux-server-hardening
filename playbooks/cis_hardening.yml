---
# ============================================================================
# Playbook de Durcissement CIS Ubuntu/Debian
# ============================================================================
# Ce playbook applique les recommandations de durcissement CIS (Center for 
# Internet Security) via le rÃ´le hardening consolidÃ©.
#
# Compatible avec:
# - Serveurs physiques (Linux - Debian/Ubuntu)
# - Machines virtuelles (KVM, VMware, Hyper-V, etc.)
# - Conteneurs Docker (avec conditions adaptÃ©es)
#
# Usage:
#   ansible-playbook playbooks/cis_hardening.yml -i inventory/hosts
#   ansible-playbook playbooks/cis_hardening.yml -i inventory/hosts -t hardening,ssh
#   ansible-playbook playbooks/cis_hardening.yml -i inventory/hosts --check
#   ansible-playbook playbooks/cis_hardening.yml -i inventory/hosts -e "skip_firewall=true"
# ============================================================================

- name: CIS Ubuntu/Debian Hardening - Application des rÃ¨gles de sÃ©curitÃ©
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    # Variables de configuration du durcissement
    skip_firewall: false              # Passer le firewall si true
    skip_aide: false                  # Passer AIDE (FIM) si true (peut Ãªtre lourd)
    skip_sudo_hardening: false        # Passer sudo hardening si true
    enable_verbose_logging: true      # Messages dÃ©taillÃ©s pendant l'exÃ©cution
    # ExÃ©cuter un audit avant et/ou aprÃ¨s le durcissement
    run_pre_audit: true               # lancer l'audit avant l'application des rÃ¨gles
    run_audit_after_hardening: false  # lancer l'audit aprÃ¨s l'application des rÃ¨gles
    audit_reports_local_dir: "{{ playbook_dir }}/reports"

  pre_tasks:
    - name: "ğŸ” VÃ©rification prÃ©alable - Ansible version"
      debug:
        msg: "Ansible version: {{ ansible_version.full }}"
      run_once: yes
      tags:
        - always
        - hardening

    - name: "ğŸ“‹ Informations du systÃ¨me cible"
      debug:
        msg: |
          HÃ´te: {{ inventory_hostname }}
          OS: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}
          Kernel: {{ ansible_facts['kernel_version'] }}
          Type de virtualisation: {{ ansible_facts.get('virtualization_type', 'bare-metal') }}
          Architecture: {{ ansible_facts['architecture'] }}
      when: enable_verbose_logging | bool
      tags:
        - always
        - hardening

    - name: "âš ï¸  Avertissement - Mode check"
      debug:
        msg: |
          âš ï¸  ATTENTION: Le playbook s'exÃ©cute en MODE CHECK (lecture seule)
          Les modifications NE seront PAS appliquÃ©es
          Utilisez: ansible-playbook ... (sans --check) pour appliquer les changements
      when: ansible_check_mode
      tags:
        - always
        - hardening

    - name: "ğŸ³ Avertissement - Environnement Docker dÃ©tectÃ©"
      debug:
        msg: |
          â„¹ï¸  Docker dÃ©tectÃ©: {{ ansible_facts.get('virtualization_type') }}
          Les tÃ¢ches liÃ©es au bootloader et services seront ignorÃ©es
          Seules les configurations adaptÃ©es Ã  Docker seront appliquÃ©es
      when: ansible_facts.get('virtualization_type', '') == 'docker'
      tags:
        - always
        - hardening

    - name: "ğŸ§¾ ExÃ©cuter l'audit prÃ©liminaire (vÃ©rification baseline)"
      include_role:
        name: audit
      when: run_pre_audit | bool
      tags:
        - audit
        - pre-audit

  roles:
    # RÃ´le hardening - Application des rÃ¨gles CIS de durcissement
    - name: hardening
      tags:
        - hardening
        - cis

  post_tasks:
    - name: "âœ… RÃ©sumÃ© du durcissement appliquÃ©"
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ“ Durcissement CIS complÃ©tÃ© pour {{ inventory_hostname }}
          
          Sections appliquÃ©es:
          âœ“ 1.x - Configuration du systÃ¨me (modules, partitions, apparmor)
          âœ“ 2.x - Services et SSH
          âœ“ 3.x - SystÃ¨me de fichiers
          âœ“ 4.x - Journalisation (rsyslog, auditd)
          âœ“ 5.x - Permissions et limite de session
          âœ“ 6.x - Comptes systÃ¨me
          âœ“ 7.x - Firewall (UFW, iptables)
          âœ“ 8.x - Sudo et Audit avancÃ©
          âœ“ 9.x - IntÃ©gritÃ© des fichiers (AIDE)
          âœ“ 10.x - Synchronisation horaire (Chrony)
          âœ“ 11.x - Modules filesystem sÃ©curisÃ©s
          
          âš ï¸  Note: Les services seront redÃ©marrÃ©s si nÃ©cessaire
          âš ï¸  En Docker, seules les configurations compatibles ont Ã©tÃ© appliquÃ©es
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      tags:
        - hardening
        - summary

    - name: "ğŸ” VÃ©rifications rapides aprÃ¨s durcissement"
      debug:
        msg: |
          VÃ©rifications post-durcissement pour {{ inventory_hostname }}:
          
          Pour valider manuellement:
          
          SSH:
            sudo grep "PermitRootLogin" /etc/ssh/sshd_config
            sudo grep "PasswordAuthentication" /etc/ssh/sshd_config
          
          Firewall (non-Docker):
            sudo ufw status
            sudo iptables -L -n
          
          Sudo:
            sudo visudo -c
          
          Auditd (non-Docker):
            sudo systemctl status auditd
            sudo auditctl -l
          
          AppArmor:
            sudo aa-status
      tags:
        - hardening
        - summary
        - verification

    - name: "ğŸ§¾ Optionnel: ExÃ©cuter l'audit aprÃ¨s durcissement (gÃ©nÃ©ration et collecte des rapports)"
      include_role:
        name: audit
      when: run_audit_after_hardening | bool
      tags:
        - audit
        - report

    - name: "ğŸ“ Lister les rapports collectÃ©s (machine de contrÃ´le)"
      ansible.builtin.find:
        path: "{{ audit_reports_local_dir }}/{{ inventory_hostname }}"
        file_type: file
      delegate_to: localhost
      register: collected_reports
      when: run_audit_after_hardening | bool
      tags:
        - report

    - name: "ğŸ“ Afficher les rapports collectÃ©s"
      ansible.builtin.debug:
        msg: |
          Rapports collectÃ©s pour {{ inventory_hostname }}:
          {% for f in collected_reports.files %}
          - {{ f.path }} ({{ f.size }} bytes)
          {% endfor %}
      delegate_to: localhost
      when: run_audit_after_hardening | bool
      tags:
        - report

  handlers:
    - name: Restart SSH
      ansible.builtin.service:
        name: sshd
        state: restarted
      when: ansible_facts.get('ansible_virtualization_type', '') != 'docker'
      ignore_errors: yes
      listen: "Restart SSH"

    - name: Restart UFW
      ansible.builtin.service:
        name: ufw
        state: restarted
      when: 
        - ansible_facts.get('ansible_virtualization_type', '') != 'docker'
        - not skip_firewall | bool
      ignore_errors: yes
      listen: "Restart UFW"

    - name: Restart auditd
      ansible.builtin.service:
        name: auditd
        state: restarted
      when: ansible_facts.get('ansible_virtualization_type', '') != 'docker'
      ignore_errors: yes
      listen: "Restart auditd"
