---
# ============================================================================
# Playbook d'Audit de ConformitÃ© CIS
# ============================================================================
# Ce playbook exÃ©cute le rÃ´le audit pour vÃ©rifier la conformitÃ© CIS,
# gÃ©nÃ©rer des rapports et les collecter sur la machine de contrÃ´le.
# ============================================================================

- name: Audit de ConformitÃ© CIS - VÃ©rification et Rapports
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    # RÃ©pertoire local sur la machine de contrÃ´le pour les rapports
    audit_reports_local_dir: "{{ playbook_dir }}/reports"
    # Variable pour le rÃ´le audit (voir roles/audit/vars/main.yml)
    audit_report_json: /tmp/audit_report.json
    audit_report_html: /tmp/audit_report.html

  pre_tasks:
    - name: "ğŸ” VÃ©rification - Ansible version"
      debug:
        msg: "Ansible version: {{ ansible_version.full }}"
      run_once: yes
      tags:
        - always
        - audit

    - name: "ğŸ“‹ Informations systÃ¨me"
      debug:
        msg: |
          HÃ´te: {{ inventory_hostname }}
          OS: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}
          Kernel: {{ ansible_facts['kernel_version'] }}
          Type de virtualisation: {{ ansible_facts.get('virtualization_type', 'unknown') }}
      tags:
        - always
        - audit

  roles:
    # RÃ´le audit - VÃ©rifications de conformitÃ© CIS et gÃ©nÃ©ration de rapports
    - name: audit
      tags:
        - audit
        - cis
        - compliance

  post_tasks:
    - name: "ğŸ“Š Afficher le rÃ©sumÃ© des rapports gÃ©nÃ©rÃ©s"
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ“ Audit complÃ©tÃ© pour {{ inventory_hostname }}
          
          Rapports gÃ©nÃ©rÃ©s sur les hÃ´tes:
          - JSON: /tmp/audit_report_{{ inventory_hostname }}.json
          - HTML: /tmp/audit_report_{{ inventory_hostname }}.html
          
          Rapports collectÃ©s sur la machine de contrÃ´le:
          - {{ audit_reports_local_dir }}/{{ inventory_hostname }}/
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      tags:
        - audit
        - report
        - summary

    - name: " Lister les rapports gÃ©nÃ©rÃ©s (machine de contrÃ´le)"
      ansible.builtin.find:
        path: "{{ audit_reports_local_dir }}/{{ inventory_hostname }}"
        file_type: file
      delegate_to: localhost
      register: generated_reports
      tags:
        - audit
        - report
        - summary

    - name: " Afficher les fichiers de rapport"
      debug:
        msg: |
          Fichiers de rapport disponibles:
          {% for report in generated_reports.files %}
          - {{ report.path }} ({{ report.size }} bytes)
          {% endfor %}
      delegate_to: localhost
      tags:
        - audit
        - report
        - summary

  handlers:
    - name: Restart auditd
      ansible.builtin.service:
        name: auditd
        state: restarted
      when: ansible_facts.get('ansible_virtualization_type', '') != 'docker'
      listen: "Restart auditd"
