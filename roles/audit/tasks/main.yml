---
# RÃ´le Audit - VÃ©rification de conformitÃ© CIS et gÃ©nÃ©ration de rapports
# Compatible avec Docker et serveurs physiques

# ============================================================================
# 1. PrÃ©paration de l'environnement
# ============================================================================
- name: Update apt cache (Debian/Ubuntu)
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  when: ansible_pkg_mgr == 'apt'
  changed_when: false
  tags:
    - audit
    - cis
  retries: 3
  delay: 10

- name: Ensure audit tools are installed
  ansible.builtin.package:
    name:
      - auditd
      - audispd-plugins
      - jq
    state: present
  tags:
    - audit
    - cis
  retries: 3
  delay: 10

- name: Ensure audit rules directory exists
  ansible.builtin.file:
    path: /etc/audit/rules.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - audit
    - cis

# ============================================================================
# 2. DÃ©ploiement des rÃ¨gles d'audit CIS (inline, pas de fichier externe)
# ============================================================================
- name: Deploy CIS audit rules - System calls
  ansible.builtin.copy:
    dest: /etc/audit/rules.d/cis.rules
    content: |
      # RÃ¨gles d'audit CIS pour Debian/Ubuntu
      # Supprime les rÃ¨gles prÃ©cÃ©dentes
      -D
      
      # Filtre par dÃ©faut
      -b 8192
      -f 1
      
      # 4.1.1.1 Enregistrer les appels systÃ¨me
      -a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
      -a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change
      -a always,exit -F arch=b64 -S clock_settime -k time-change
      -a always,exit -F arch=b32 -S clock_settime -k time-change
      -w /etc/localtime -p wa -k time-change
      
      # 4.1.1.2 Auditer les modifications d'utilisateurs/groupes
      -w /etc/group -p wa -k identity
      -w /etc/passwd -p wa -k identity
      -w /etc/gshadow -p wa -k identity
      -w /etc/shadow -p wa -k identity
      -w /etc/security/opasswd -p wa -k identity
      
      # 4.1.1.3 Auditer les modifications de permissions de fichiers
      -a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=-1 -k perm_mod
      -a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=-1 -k perm_mod
      -a always,exit -F arch=b64 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=-1 -k perm_mod
      -a always,exit -F arch=b32 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=-1 -k perm_mod
      
      # 4.1.1.4 Auditer l'utilisation de sudo
      -w /etc/sudoers -p wa -k scope
      -w /etc/sudoers.d/ -p wa -k scope
      
      # 4.1.1.5 Auditer les modifications du systÃ¨me
      -w /sbin/insmod -p x -k modules
      -w /sbin/rmmod -p x -k modules
      -w /sbin/modprobe -p x -k modules
      -a always,exit -F arch=b64 -S init_module -S delete_module -k modules
      
      # Make configuration immutable
      -e 2
    owner: root
    group: root
    mode: '0640'
    backup: yes
  notify: Restart auditd
  tags:
    - audit
    - cis

- name: Enable auditd service (non-Docker only)
  ansible.builtin.service:
    name: auditd
    state: started
    enabled: yes
  when: ansible_facts.get('ansible_virtualization_type', '') != 'docker'
  tags:
    - audit
    - cis
  ignore_errors: yes

# ============================================================================
# 3. VÃ©rifications de conformitÃ© CIS - Modules noyau interdits
# ============================================================================
- name: Check for forbidden kernel modules
  ansible.builtin.shell: |
    set -o pipefail
    for module in cramfs freevxfs hfs hfsplus jffs2 usb-storage firewire-core; do
      if modinfo $module &>/dev/null; then
        if lsmod | grep -q "^${module}"; then
          echo "FAIL: $module est chargÃ©"
        else
          echo "OK: $module n'est pas chargÃ©"
        fi
      fi
    done
  register: kernel_modules_check
  changed_when: false
  failed_when: false
  check_mode: no
  tags:
    - audit
    - cis
    - compliance

- name: Report forbidden kernel modules status
  ansible.builtin.debug:
    msg: "{{ kernel_modules_check.stdout_lines }}"
  tags:
    - audit
    - cis
    - compliance

# ============================================================================
# 4. VÃ©rifications de conformitÃ© CIS - SSH
# ============================================================================
- name: Check SSH configuration (PermitRootLogin)
  ansible.builtin.shell: |
    grep -i "^PermitRootLogin" /etc/ssh/sshd_config | awk '{print $2}'
  register: ssh_root_login
  changed_when: false
  failed_when: false
  check_mode: no
  tags:
    - audit
    - cis
    - compliance

- name: Check SSH configuration (PasswordAuthentication)
  ansible.builtin.shell: |
    grep -i "^PasswordAuthentication" /etc/ssh/sshd_config | awk '{print $2}'
  register: ssh_password_auth
  changed_when: false
  failed_when: false
  check_mode: no
  tags:
    - audit
    - cis
    - compliance

- name: Report SSH configuration
  ansible.builtin.debug:
    msg: |
      SSH Configuration Check:
      - PermitRootLogin: {{ ssh_root_login.stdout | default('NOT FOUND', true) }}
      - PasswordAuthentication: {{ ssh_password_auth.stdout | default('NOT FOUND', true) }}
  tags:
    - audit
    - cis
    - compliance

# ============================================================================
# 5. VÃ©rifications de conformitÃ© CIS - Permissions fichiers systÃ¨me
# ============================================================================
- name: Check system file permissions
  ansible.builtin.stat:
    path: "{{ item }}"
  register: file_perms
  loop:
    - /etc/passwd
    - /etc/shadow
    - /etc/group
    - /etc/gshadow
    - /etc/ssh/sshd_config
  tags:
    - audit
    - cis
    - compliance

- name: Report file permissions
  ansible.builtin.debug:
    msg: |
      VÃ©rification des permissions fichiers systÃ¨me:
      {% for item in file_perms.results %}
      - {{ item.item }}: mode={{ item.stat.mode }}, owner={{ item.stat.pw_name }}:{{ item.stat.gr_name }}
      {% endfor %}
  tags:
    - audit
    - cis
    - compliance

# ============================================================================
# 6. VÃ©rifications de conformitÃ© CIS - Firewall
# ============================================================================
- name: Check UFW status
  ansible.builtin.shell: |
    ufw status | head -1
  register: ufw_status
  changed_when: false
  failed_when: false
  check_mode: no
  tags:
    - audit
    - cis
    - compliance

- name: Report Firewall status
  ansible.builtin.debug:
    msg: "Firewall UFW Status: {{ ufw_status.stdout }}"
  tags:
    - audit
    - cis
    - compliance

# ============================================================================
# 7. GÃ©nÃ©ration du rapport JSON d'audit
# ============================================================================
- name: Create audit report directory
  ansible.builtin.file:
    path: "{{ audit_reports_local_dir | default(playbook_dir + '/reports') }}/{{ inventory_hostname }}"
    state: directory
    mode: '0755'
  delegate_to: localhost
  tags:
    - audit
    - report

- name: Generate audit compliance JSON report
  ansible.builtin.template:
    src: audit_compliance_report.j2
    dest: /tmp/audit_report_{{ inventory_hostname }}.json
    owner: root
    group: root
    mode: '0640'
  tags:
    - audit
    - report

- name: Fetch audit compliance JSON report to control node
  ansible.builtin.fetch:
    src: "/tmp/audit_report_{{ inventory_hostname }}.json"
    dest: "{{ audit_reports_local_dir | default(playbook_dir + '/reports') }}/{{ inventory_hostname }}/audit_report.json"
    flat: yes
  tags:
    - audit
    - report
  ignore_errors: yes

# ============================================================================
# 8. GÃ©nÃ©ration du rapport HTML d'audit
# ============================================================================
- name: Generate audit compliance HTML report
  ansible.builtin.template:
    src: audit_compliance_report.html.j2
    dest: /tmp/audit_report_{{ inventory_hostname }}.html
    owner: root
    group: root
    mode: '0640'
  tags:
    - audit
    - report

- name: Fetch audit compliance HTML report to control node
  ansible.builtin.fetch:
    src: "/tmp/audit_report_{{ inventory_hostname }}.html"
    dest: "{{ audit_reports_local_dir | default(playbook_dir + '/reports') }}/{{ inventory_hostname }}/audit_report.html"
    flat: yes
  tags:
    - audit
    - report
  ignore_errors: yes

# ============================================================================
# 9. RÃ©sumÃ© de l'audit
# ============================================================================
- name: Display audit summary
  ansible.builtin.debug:
    msg: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ“Š AUDIT SUMMARY - {{ inventory_hostname }}
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      âœ“ Audit rules deployed
      âœ“ Kernel modules check completed
      âœ“ SSH configuration verified
      âœ“ File permissions checked
      âœ“ Firewall status verified
      âœ“ JSON report generated: /tmp/audit_report_{{ inventory_hostname }}.json
      âœ“ HTML report generated: /tmp/audit_report_{{ inventory_hostname }}.html
      âœ“ Reports fetched to: {{ audit_reports_local_dir | default(playbook_dir + '/reports') }}/{{ inventory_hostname }}/
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  tags:
    - audit
    - report
    - summary
